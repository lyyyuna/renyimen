# 任意门智能导航系统 - 技术架构文档

## 项目概述

任意门是一个基于Python构建的智能导航应用，采用Qt GUI框架（PySide6）作为用户界面，集成语音识别、AI自然语言处理和多地图导航服务。项目入口文件为`main.py`，采用模块化架构设计。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    任意门智能导航系统                          │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │              用户界面层 (UI Layer)                     │  │
│  │  ┌─────────────────────────────────────────────────┐  │  │
│  │  │         PySide6 GUI (main.py)                   │  │  │
│  │  │  - InputApp (主窗口)                           │  │  │
│  │  │  - 文本输入框 / 语音按钮                       │  │  │
│  │  │  - 地图提供商选择                               │  │  │
│  │  │  - 唤醒词监听 / 结果显示                       │  │  │
│  │  └─────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │              业务逻辑层 (Business Layer)               │  │
│  │  ┌─────────────────┐  ┌─────────────────────────────┐  │  │
│  │  │ 多线程处理       │  │ 导航服务管理                 │  │  │
│  │  │ - 语音识别线程   │  │ - NavigationService         │  │  │
│  │  │ - 导航处理线程   │  │ - 地图提供商选择            │  │  │
│  │  │ - 异步事件循环   │  │ - 路线规划逻辑              │  │  │
│  │  └─────────────────┘  └─────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │               服务层 (Service Layer)                   │  │
│  │  ┌────────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │ 语音识别服务    │  │ AI处理服务   │  │ 地图服务    │  │  │
│  │  │ - SpeechRec... │  │ - Claude CLI │  │ - 高德地图  │  │  │
│  │  │ - 唤醒词检测   │  │ - MCP Server │  │ - 百度地图  │  │  │
│  │  │ - 语音转文字   │  │ - 自然语言处理│  │ - API集成   │  │  │
│  │  │ - Qiniu ASR   │  │ - 意图解析   │  │ - URL生成   │  │  │
│  │  └────────────────┘  └─────────────┘  └─────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │               基础设施层 (Infrastructure)               │  │
│  │  ┌────────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │ 第三方API      │  │ 音频处理    │  │ 网络通信    │  │  │
│  │  │ - 高德地图API  │  │ - PyAudio   │  │ - Requests  │  │  │
│  │  │ - 百度地图API  │  │ - SpeechRec.│  │ - WebSocket │  │  │
│  │  │ - Qiniu ASR   │  │ - 音频格式转换│  │ - HTTP请求  │  │  │
│  │  │ - Google ASR  │  │             │  │             │  │  │
│  │  └────────────────┘  └─────────────┘  └─────────────┘  │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块架构

### 1. 用户界面层 (main.py)

**主要组件：**
- `InputApp`: 主窗口类，继承自QWidget
- `VoiceRecognitionWorker`: 语音识别线程，继承自QThread
- `NavigationWorker`: 导航处理线程，继承自QThread

**设计模式：**
- **MVC模式**: 界面与业务逻辑分离
- **观察者模式**: 通过Qt信号槽机制实现组件通信
- **工作线程模式**: 使用QThread避免UI阻塞

**关键功能：**
```python
# 主要UI组件
- QLineEdit: 文本输入框
- QPushButton: 语音按钮、确认按钮、唤醒监听按钮
- QComboBox: 地图提供商选择
- QTextEdit: 结果显示区域
- QProgressBar: 进度指示器
```

### 2. 语音识别服务 (voice_recognition_service.py)

**技术栈：**
- **SpeechRecognition**: 基础语音识别框架
- **PyAudio**: 音频采集
- **Qiniu ASR**: 七牛云语音识别WebSocket API
- **Google Speech API**: 备用语音识别服务

**架构特点：**
- **双重识别策略**: 优先使用Qiniu ASR，失败时回退到Google
- **WebSocket通信**: 实时语音流处理
- **协议解析**: 自定义二进制协议解析Qiniu响应
- **异步处理**: 基于asyncio的异步音频处理

**核心流程：**
```python
async def listen_and_recognize():
    1. 音频采集 (PyAudio)
    2. PCM格式转换
    3. Qiniu ASR WebSocket发送
    4. 协议解析响应
    5. 文本结果返回
    6. 失败时回退Google ASR
```

### 3. AI智能处理服务

**Claude CLI集成：**
- **外部进程调用**: 通过subprocess调用Claude CLI
- **MCP协议**: 使用Model Context Protocol进行工具交互
- **配置文件**: claude_desktop_config.json配置MCP服务器

**处理流程：**
```python
NavigationWorker.run():
    1. 构建AI提示词
    2. 调用Claude CLI + MCP配置
    3. 自然语言意图解析
    4. 提取导航参数
    5. 返回结构化结果
```

### 4. MCP导航服务器 (mcp_navigation_server.py)

**MCP架构：**
- **Server**: 基于mcp.server.Server构建
- **Tool定义**: 注册navigate工具
- **标准输入输出**: stdio通信协议

**工具接口：**
```python
navigate_tool_schema = {
    "name": "navigate",
    "description": "根据起点和终点打开地图导航链接",
    "inputSchema": {
        "start_point": "起点名称",
        "end_point": "终点名称", 
        "start_city": "起点城市(可选)",
        "end_city": "终点城市(可选)",
        "transport_mode": "交通方式",
        "provider": "地图提供商"
    }
}
```

### 5. 导航服务层 (navigation_service.py)

**服务聚合器：**
- **提供商抽象**: 统一高德和百度地图接口
- **环境变量配置**: 通过MAP_PROVIDER切换地图服务
- **URL生成和浏览器启动**: 统一的导航链接处理

### 6. 地图服务实现

#### 高德地图服务 (amap_service.py)
**API集成：**
- **POI搜索**: /v3/place/text接口
- **地理编码**: /v3/geocode/geo接口  
- **IP定位**: /v3/ip接口
- **URL构建**: 高德地图Web版导航链接

**数据流：**
```python
1. 地点名称 → POI搜索 → 坐标+详细信息
2. 地址文本 → 地理编码 → 坐标
3. 当前位置 → IP定位 → 坐标
4. 坐标+参数 → URL构建 → 导航链接
```

#### 百度地图服务 (baidu_service.py)
**API集成：**
- **地点检索**: /place/v2/search接口
- **地理编码**: /geocoding/v3接口
- **IP定位**: /location/ip接口
- **URL构建**: 百度地图Web版导航链接

## 数据流架构

### 1. 用户交互流程
```
用户输入 → UI事件 → 业务逻辑 → 服务调用 → 外部API → 结果返回 → UI更新
```

### 2. 语音识别流程
```
音频采集 → PCM转换 → WebSocket发送 → 协议解析 → 文本提取 → 意图识别
```

### 3. AI处理流程
```
自然语言 → Claude CLI → MCP工具调用 → 参数提取 → 导航服务 → 地图API
```

### 4. 错误处理流程
```
API失败 → 备用服务 → 本地解析 → 用户提示 → 操作重试
```

## 关键技术决策

### 1. 线程模型
- **主线程**: UI渲染和事件处理
- **工作线程**: 语音识别、AI处理、网络请求
- **异步处理**: 语音识别内部使用asyncio

### 2. 通信协议
- **Qt信号槽**: UI组件间通信
- **WebSocket**: 实时语音流处理
- **HTTP REST**: 地图API调用
- **MCP Protocol**: AI工具交互
- **进程间通信**: Claude CLI调用

### 3. 配置管理
- **环境变量**: API密钥和服务配置
- **JSON配置**: MCP服务器配置
- **代码配置**: UI参数和默认值

### 4. 错误恢复策略
- **服务降级**: Qiniu ASR → Google ASR
- **备用解析**: AI解析失败 → 本地正则匹配
- **超时处理**: 网络请求超时重试
- **用户反馈**: 详细错误信息显示

## 扩展性设计

### 1. 地图服务扩展
- **接口标准化**: 统一的LocationService接口
- **服务注册**: 动态地图服务提供商注册
- **配置驱动**: 通过配置文件添加新地图服务

### 2. 语音引擎扩展
- **引擎抽象**: 统一的语音识别接口
- **优先级队列**: 多引擎按优先级尝试
- **插件机制**: 动态加载语音识别插件

### 3. AI模型扩展
- **模型抽象**: 统一的AI处理接口
- **提示词模板**: 可配置的AI提示词
- **多模型支持**: 不同AI模型的并行处理

## 依赖关系

### 核心依赖
```toml
[dependencies]
pyside6 = ">=6.9.1"          # GUI框架
mcp = ">=1.19.0"             # Model Context Protocol
requests = ">=2.32.5"        # HTTP客户端
speechrecognition = ">=3.10.0" # 语音识别
pyaudio = ">=0.2.13"         # 音频处理
websockets = ">=10.0"        # WebSocket客户端
qasync = ">=0.28.0"          # Qt异步支持
```

### 外部服务依赖
- **Claude CLI**: AI自然语言处理
- **高德地图API**: 地理位置服务
- **百度地图API**: 地理位置服务  
- **Qiniu ASR**: 语音识别服务
- **Google Speech API**: 备用语音识别

## 性能考虑

### 1. 响应时间优化
- **并行处理**: 语音识别和UI响应并行
- **缓存机制**: 地理位置信息本地缓存
- **连接复用**: WebSocket连接复用

### 2. 资源管理
- **线程池**: 限制并发线程数量
- **内存管理**: 及时释放音频数据
- **连接管理**: 主动关闭WebSocket连接

### 3. 用户体验
- **渐进式加载**: 逐步显示处理进度
- **错误恢复**: 自动重试和备用方案
- **状态反馈**: 实时状态指示器

## 安全考虑

### 1. API密钥管理
- **环境变量**: 敏感信息不硬编码
- **配置文件**: 本地配置文件保护
- **密钥轮换**: 支持API密钥更新

### 2. 网络安全
- **HTTPS通信**: 所有API调用使用HTTPS
- **输入验证**: 用户输入参数验证
- **错误信息**: 避免敏感信息泄露

### 3. 隐私保护
- **本地处理**: 尽可能本地处理用户数据
- **数据最小化**: 只传输必要的数据
- **临时存储**: 音频数据及时清理